$.extend($.fn.datagrid.defaults,{groupHeight:30,expanderWidth:30,groupStyler:function(){return""}});var groupview=$.extend({},$.fn.datagrid.defaults.view,{render:function(e,t,r){for(var a=[],i=this.groups,o=0;o<i.length;o++)a.push(this.renderGroup.call(this,e,o,i[o],r));$(t).html(a.join(""))},renderGroup:function(e,t,r,a){function i(e,t){var r="",a="";return"string"==typeof e?a=e:e&&(r=e["class"]||"",a=e.style||""),'class="'+t+(r?" "+r:"")+'" style="'+a+'"'}var o=$.data(e,"datagrid"),n=o.options,d=$(e).datagrid("getColumnFields",a);if(a&&!(n.rownumbers||n.frozenColumns&&n.frozenColumns.length))return"";var l=[],s=n.groupStyler.call(e,r.value,r.rows),u=i(s,"datagrid-group");l.push("<div group-index="+t+" "+u+">"),(a&&(n.rownumbers||n.frozenColumns.length)||!a&&!n.rownumbers&&!n.frozenColumns.length)&&(l.push('<span class="datagrid-group-expander">'),l.push('<span class="datagrid-row-expander datagrid-row-collapse">&nbsp;</span>'),l.push("</span>")),a||(l.push('<span class="datagrid-group-title">'),l.push(n.groupFormatter.call(e,r.value,r.rows)),l.push("</span>")),l.push("</div>"),l.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var f=r.startIndex,c=0;c<r.rows.length;c++){var s=n.rowStyler?n.rowStyler.call(e,f,r.rows[c]):"",g="",h="";"string"==typeof s?h=s:s&&(g=s["class"]||"",h=s.style||"");var p='class="datagrid-row '+(f%2&&n.striped?"datagrid-row-alt ":" ")+g+'"',v=h?'style="'+h+'"':"",m=o.rowIdPrefix+"-"+(a?1:2)+"-"+f;l.push('<tr id="'+m+'" datagrid-row-index="'+f+'" '+p+" "+v+">"),l.push(this.renderRow.call(this,e,d,a,f,r.rows[c])),l.push("</tr>"),f++}return l.push("</tbody></table>"),l.join("")},bindEvents:function(e){var t=$.data(e,"datagrid"),r=t.dc,a=r.body1.add(r.body2),i=($.data(a[0],"events")||$._data(a[0],"events")).click[0].handler;a.unbind("click").bind("click",function(t){var r=$(t.target),a=r.closest("span.datagrid-row-expander");if(a.length){var o=a.closest("div.datagrid-group").attr("group-index");a.hasClass("datagrid-row-collapse")?$(e).datagrid("collapseGroup",o):$(e).datagrid("expandGroup",o)}else i(t);t.stopPropagation()})},onBeforeRender:function(e,t){function r(e){for(var t=0;t<n.length;t++){var r=n[t];if(r.value==e)return r}return null}function a(){$("#datagrid-group-style").length||$("head").append('<style id="datagrid-group-style">.datagrid-group{height:'+o.groupHeight+"px;background:#E0ECFF;overflow:hidden;font-weight:bold;font-size:16px;border-bottom:1px solid #ccc;}.datagrid-group-title,.datagrid-group-expander{display:inline-block;vertical-align:bottom;height:100%;line-height:"+o.groupHeight+"px;padding:0 30px;}.datagrid-group-expander{width:"+o.expanderWidth+"px;text-align:center;padding:0}.datagrid-row-expander{margin:"+Math.floor((o.groupHeight-16)/2)+"px 0;display:inline-block;width:16px;height:16px;cursor:pointer}</style>")}var i=$.data(e,"datagrid"),o=i.options;a();for(var n=[],d=0;d<t.length;d++){var l=t[d],s=r(l[o.groupField]);s?s.rows.push(l):(s={value:l[o.groupField],rows:[l]},n.push(s))}for(var u=0,f=[],d=0;d<n.length;d++){var s=n[d];s.startIndex=u,u+=s.rows.length,f=f.concat(s.rows)}i.data.rows=f,this.groups=n;var c=this;setTimeout(function(){c.bindEvents(e)},0)},onAfterRender:function(e){$.fn.datagrid.defaults.view.onAfterRender.call(this,e);var t=this,r=$.data(e,"datagrid"),a=r.options;r.onResizeColumn||(r.onResizeColumn=a.onResizeColumn),r.onResize||(r.onResize=a.onResize),a.onResizeColumn=function(i,o){a.fitColumns||t.resizeGroup(e),r.onResizeColumn.call(e,i,o)},a.onResize=function(i,o){a.fitColumns&&t.resizeGroup(e),r.onResize.call($(e).datagrid("getPanel")[0],i,o)},t.resizeGroup(e)}});$.extend($.fn.datagrid.methods,{groups:function(e){return e.datagrid("options").view.groups},expandGroup:function(e,t){return e.each(function(){var e=$.data(this,"datagrid").dc.view,r=e.find(void 0!=t?'div.datagrid-group[group-index="'+t+'"]':"div.datagrid-group"),a=r.find("span.datagrid-row-expander");a.hasClass("datagrid-row-expand")&&(a.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse"),r.next("table").show()),$(this).datagrid("fixRowHeight")})},collapseGroup:function(e,t){return e.each(function(){var e=$.data(this,"datagrid").dc.view,r=e.find(void 0!=t?'div.datagrid-group[group-index="'+t+'"]':"div.datagrid-group"),a=r.find("span.datagrid-row-expander");a.hasClass("datagrid-row-collapse")&&(a.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand"),r.next("table").hide()),$(this).datagrid("fixRowHeight")})},scrollToGroup:function(e,t){return e.each(function(){var e=$.data(this,"datagrid"),r=e.dc,a=r.body2.children('div.datagrid-group[group-index="'+t+'"]');if(a.length){var i=a.outerHeight(),o=r.view2.children("div.datagrid-header")._outerHeight(),n=r.body2.outerHeight(!0)-r.body2.outerHeight(),d=a.position().top-o-n;0>d?r.body2.scrollTop(r.body2.scrollTop()+d):d+i>r.body2.height()-18&&r.body2.scrollTop(r.body2.scrollTop()+d+i-r.body2.height()+18)}})}}),$.extend(groupview,{refreshGroupTitle:function(e,t){var r=$.data(e,"datagrid"),a=r.options,i=r.dc,o=this.groups[t],n=i.body2.children("div.datagrid-group[group-index="+t+"]").find("span.datagrid-group-title");n.html(a.groupFormatter.call(e,o.value,o.rows))},resizeGroup:function(e,t){var r=$.data(e,"datagrid"),a=r.dc,i=a.header2.find("table"),o=i.find("tr.datagrid-filter-row").hide(),n=i.width();if(void 0==t)var d=a.body2.children("div.datagrid-group");else var d=a.body2.children("div.datagrid-group[group-index="+t+"]");d._outerWidth(n),o.show()},insertRow:function(e,t,r){function a(t,r){var a=r?1:2,i=n.finder.getTr(e,t-1,"body",a),o=n.finder.getTr(e,t,"body",a);o.insertAfter(i)}var i,o=$.data(e,"datagrid"),n=o.options,d=o.dc,l=null;if(!o.data.rows.length)return void $(e).datagrid("loadData",[r]);for(var s=0;s<this.groups.length;s++)if(this.groups[s].value==r[n.groupField]){l=this.groups[s],i=s;break}l?((void 0==t||null==t)&&(t=o.data.rows.length),t<l.startIndex?t=l.startIndex:t>l.startIndex+l.rows.length&&(t=l.startIndex+l.rows.length),$.fn.datagrid.defaults.view.insertRow.call(this,e,t,r),t<l.startIndex+l.rows.length||(a(t,!0),a(t,!1)),l.rows.splice(t-l.startIndex,0,r)):(l={value:r[n.groupField],rows:[r],startIndex:o.data.rows.length},i=this.groups.length,d.body1.append(this.renderGroup.call(this,e,i,l,!0)),d.body2.append(this.renderGroup.call(this,e,i,l,!1)),this.groups.push(l),o.data.rows.push(r)),this.refreshGroupTitle(e,i),this.resizeGroup(e)},updateRow:function(e,t,r){var a=$.data(e,"datagrid").options;$.fn.datagrid.defaults.view.updateRow.call(this,e,t,r);var i=a.finder.getTr(e,t,"body",2).closest("table.datagrid-btable"),o=parseInt(i.prev().attr("group-index"));this.refreshGroupTitle(e,o)},deleteRow:function(e,t){var r=$.data(e,"datagrid"),a=r.options,i=r.dc,o=i.body1.add(i.body2),n=a.finder.getTr(e,t,"body",2).closest("table.datagrid-btable"),d=parseInt(n.prev().attr("group-index"));$.fn.datagrid.defaults.view.deleteRow.call(this,e,t);var l=this.groups[d];if(l.rows.length>1)l.rows.splice(t-l.startIndex,1),this.refreshGroupTitle(e,d);else{o.children("div.datagrid-group[group-index="+d+"]").remove();for(var s=d+1;s<this.groups.length;s++)o.children("div.datagrid-group[group-index="+s+"]").attr("group-index",s-1);this.groups.splice(d,1)}for(var t=0,s=0;s<this.groups.length;s++){var l=this.groups[s];l.startIndex=t,t+=l.rows.length}}});