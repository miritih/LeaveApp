var detailview=$.extend({},$.fn.datagrid.defaults.view,{render:function(e,t,a){var r=$.data(e,"datagrid"),i=r.options;if(!a||i.rownumbers||i.frozenColumns&&i.frozenColumns.length){var o=r.data.rows,n=$(e).datagrid("getColumnFields",a),d=[];d.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var l=0;l<o.length;l++){var s=i.rowStyler?i.rowStyler.call(e,l,o[l]):"",g="",c="";"string"==typeof s?c=s:s&&(g=s["class"]||"",c=s.style||"");var u='class="datagrid-row '+(l%2&&i.striped?"datagrid-row-alt ":" ")+g+'"',m=c?'style="'+c+'"':"",f=r.rowIdPrefix+"-"+(a?1:2)+"-"+l;d.push('<tr id="'+f+'" datagrid-row-index="'+l+'" '+u+" "+m+">"),d.push(this.renderRow.call(this,e,n,a,l,o[l])),d.push("</tr>"),d.push('<tr style="display:none;">'),d.push(a?"<td colspan="+(n.length+(i.rownumbers?1:0))+' style="border-right:0">':"<td colspan="+n.length+">"),d.push('<div class="datagrid-row-detail">'),d.push(a?"&nbsp;":i.detailFormatter.call(e,l,o[l])),d.push("</div>"),d.push("</td>"),d.push("</tr>")}d.push("</tbody></table>"),$(t).html(d.join(""))}},renderRow:function(e,t,a,r,i){var o=$.data(e,"datagrid").options,n=[];if(a&&o.rownumbers){var d=r+1;o.pagination&&(d+=(o.pageNumber-1)*o.pageSize),n.push('<td class="datagrid-td-rownumber"><div class="datagrid-cell-rownumber">'+d+"</div></td>")}for(var l=0;l<t.length;l++){var s=t[l],g=$(e).datagrid("getColumnOption",s);if(g){var c=i[s],u=g.styler?g.styler(c,i,r)||"":"",m="",f="";"string"==typeof u?f=u:n&&(m=u["class"]||"",f=u.style||"");var p=m?'class="'+m+'"':"",h=g.hidden?'style="display:none;'+f+'"':f?'style="'+f+'"':"";n.push('<td field="'+s+'" '+p+" "+h+">"),g.checkbox?h="":g.expander?h="text-align:center;height:16px;":(h=f,g.align&&(h+=";text-align:"+g.align+";"),o.nowrap?o.autoRowHeight&&(h+=";height:auto;"):h+=";white-space:normal;height:auto;"),n.push('<div style="'+h+'" '),n.push(g.checkbox?'class="datagrid-cell-check ':'class="datagrid-cell '+g.cellClass),n.push('">'),n.push(g.checkbox?'<input type="checkbox" name="'+s+'" value="'+(void 0!=c?c:"")+'">':g.expander?'<span class="datagrid-row-expander datagrid-row-expand" style="display:inline-block;width:16px;height:16px;cursor:pointer;" />':g.formatter?g.formatter(c,i,r):c),n.push("</div>"),n.push("</td>")}}return n.join("")},insertRow:function(e,t,a){function r(r){var o=r?n:d,s=o.find("tr[datagrid-row-index="+t+"]");if(l){var g=s.next().clone();s.insertAfter(s.next())}else var g=s.next().next().clone();g.insertAfter(s),g.hide(),r||g.find("div.datagrid-row-detail").html(i.detailFormatter.call(e,t,a))}var i=$.data(e,"datagrid").options,o=$.data(e,"datagrid").dc,n=($(e).datagrid("getPanel"),o.view1),d=o.view2,l=!1,s=$(e).datagrid("getRows").length;return 0==s?void $(e).datagrid("loadData",{total:1,rows:[a]}):(void 0!=t&&null!=t&&s>t||(t=s,l=!0,this.canUpdateDetail=!1),$.fn.datagrid.defaults.view.insertRow.call(this,e,t,a),r(!0),r(!1),void(this.canUpdateDetail=!0))},deleteRow:function(e,t){var a=$.data(e,"datagrid").options,r=$.data(e,"datagrid").dc,i=a.finder.getTr(e,t);i.next().remove(),$.fn.datagrid.defaults.view.deleteRow.call(this,e,t),r.body2.triggerHandler("scroll")},updateRow:function(e,t,a){var r=($.data(e,"datagrid").dc,$.data(e,"datagrid").options),i=$(e).datagrid("getExpander",t).attr("class");if($.fn.datagrid.defaults.view.updateRow.call(this,e,t,a),$(e).datagrid("getExpander",t).attr("class",i),this.canUpdateDetail){var a=$(e).datagrid("getRows")[t],o=$(e).datagrid("getRowDetail",t);o.html(r.detailFormatter.call(e,t,a))}},bindEvents:function(e){var t=$.data(e,"datagrid");if(!t.ss.bindDetailEvents){t.ss.bindDetailEvents=!0;var a=t.dc,r=(t.options,a.body1.add(a.body2)),i=($.data(r[0],"events")||$._data(r[0],"events")).click[0].handler;r.unbind("click").bind("click",function(t){var a=$(t.target),r=a.closest("tr.datagrid-row");if(r.length){if(a.hasClass("datagrid-row-expander")){var o=parseInt(r.attr("datagrid-row-index"));a.hasClass("datagrid-row-expand")?$(e).datagrid("expandRow",o):$(e).datagrid("collapseRow",o),$(e).datagrid("fixRowHeight")}else i(t);t.stopPropagation()}})}},onBeforeRender:function(e){for(var t=$.data(e,"datagrid"),a=t.options,r=t.dc,i=$(e),o=!1,n=i.datagrid("getColumnFields",!0).concat(i.datagrid("getColumnFields")),d=0;d<n.length;d++){var l=i.datagrid("getColumnOption",n[d]);if(l.expander){o=!0;break}}if(!o){a.frozenColumns&&a.frozenColumns.length?a.frozenColumns[0].splice(0,0,{field:"_expander",expander:!0,width:24,resizable:!1,fixed:!0}):a.frozenColumns=[[{field:"_expander",expander:!0,width:24,resizable:!1,fixed:!0}]];var i=r.view1.children("div.datagrid-header").find("table"),s=$('<td rowspan="'+a.frozenColumns.length+'"><div class="datagrid-header-expander" style="width:24px;"></div></td>');0==$("tr",i).length?s.wrap("<tr></tr>").parent().appendTo($("tbody",i)):a.rownumbers?s.insertAfter(i.find("td:has(div.datagrid-header-rownumber)")):s.prependTo(i.find("tr:first"))}},onAfterRender:function(e){function t(){var e=r.header2.find("table"),t=e.find("tr.datagrid-filter-row").hide(),a=e.width()-1,i=r.body2.find(">table.datagrid-btable>tbody>tr>td>div.datagrid-row-detail:visible")._outerWidth(a);i.find(".easyui-fluid").trigger("_resize"),t.show()}var a=$.data(e,"datagrid"),r=a.dc,i=a.options,o=$(e).datagrid("getPanel");$.fn.datagrid.defaults.view.onAfterRender.call(this,e),a.onResizeColumn||(a.onResizeColumn=i.onResizeColumn),a.onResize||(a.onResize=i.onResize),i.onResizeColumn=function(r,o){i.fitColumns||t();for(var n=$(e).datagrid("getRows").length,d=0;n>d;d++)$(e).datagrid("fixDetailRowHeight",d);a.onResizeColumn.call(e,r,o)},i.onResize=function(e,r){i.fitColumns&&t(),a.onResize.call(o,e,r)},this.canUpdateDetail=!0;var n=r.footer1.add(r.footer2);n.find("span.datagrid-row-expander").css("visibility","hidden"),$(e).datagrid("resize"),this.bindEvents(e);var d=r.body1.add(r.body2).find("div.datagrid-row-detail");d.unbind().bind("mouseover mouseout click dblclick contextmenu scroll",function(e){e.stopPropagation()})}});$.extend($.fn.datagrid.methods,{fixDetailRowHeight:function(e,t){return e.each(function(){var e=$.data(this,"datagrid").options;if(e.rownumbers||e.frozenColumns&&e.frozenColumns.length){var a=$.data(this,"datagrid").dc,r=e.finder.getTr(this,t,"body",1).next(),i=e.finder.getTr(this,t,"body",2).next();if(i.is(":visible")){r.css("height",""),i.css("height","");var o=Math.max(r.height(),i.height());r.css("height",o),i.css("height",o)}a.body2.triggerHandler("scroll")}})},getExpander:function(e,t){var a=$.data(e[0],"datagrid").options;return a.finder.getTr(e[0],t).find("span.datagrid-row-expander")},getRowDetail:function(e,t){var a=$.data(e[0],"datagrid").options,r=a.finder.getTr(e[0],t,"body",2);return r.next().find(">td>div.datagrid-row-detail")},expandRow:function(e,t){return e.each(function(){var e=$(this).datagrid("options"),a=($.data(this,"datagrid").dc,$(this).datagrid("getExpander",t));if(a.hasClass("datagrid-row-expand")){a.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");var r=e.finder.getTr(this,t,"body",1).next(),i=e.finder.getTr(this,t,"body",2).next();if(r.show(),i.show(),$(this).datagrid("fixDetailRowHeight",t),e.onExpandRow){var o=$(this).datagrid("getRows")[t];e.onExpandRow.call(this,t,o)}}})},collapseRow:function(e,t){return e.each(function(){var e=$(this).datagrid("options"),a=$.data(this,"datagrid").dc,r=$(this).datagrid("getExpander",t);if(r.hasClass("datagrid-row-collapse")){r.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");var i=e.finder.getTr(this,t,"body",1).next(),o=e.finder.getTr(this,t,"body",2).next();if(i.hide(),o.hide(),a.body2.triggerHandler("scroll"),e.onCollapseRow){var n=$(this).datagrid("getRows")[t];e.onCollapseRow.call(this,t,n)}}})}}),$.extend($.fn.datagrid.methods,{subgrid:function(e,t){return e.each(function(){function e(t,o,n){var d=$.extend({},o.options.queryParams||{});d[o.options.foreignField]=n?n[o.options.foreignField]:void 0,$(t).datagrid($.extend({},o.options,{subgrid:o.subgrid,view:o.subgrid?detailview:void 0,queryParams:d,detailFormatter:function(){return'<div><table class="datagrid-subgrid"></table></div>'},onExpandRow:function(t,r){var n=$(this).datagrid("options"),d=$(this).datagrid("getRowDetail",t),l=a(d);l.data("datagrid")||e(l[0],n.subgrid,r),d.find(".easyui-fluid").trigger("_resize"),i(this,t),o.options.onExpandRow&&o.options.onExpandRow.call(this,t,r)},onCollapseRow:function(e,t){i(this,e),o.options.onCollapseRow&&o.options.onCollapseRow.call(this,e,t)},onResize:function(){$(this).children("div.datagrid-view").children("table");r(this)},onResizeColumn:function(e,t){r(this),o.options.onResizeColumn&&o.options.onResizeColumn.call(this,e,t)},onLoadSuccess:function(e){r(this),o.options.onLoadSuccess&&o.options.onLoadSuccess.call(this,e)}}))}function a(e){var t=$(e).children("div");return t.find(t.children("div.datagrid").length?">div.datagrid>div.panel-body>div.datagrid-view>table.datagrid-subgrid":">table.datagrid-subgrid")}function r(e){var t=$(e).closest("div.datagrid-row-detail").closest("tr").prev();if(t.length){var a=parseInt(t.attr("datagrid-row-index")),r=t.closest("div.datagrid-view").children("table");i(r[0],a)}}function i(e,t){$(e).datagrid("fixDetailRowHeight",t),$(e).datagrid("fixRowHeight",t);var a=$(e).closest("div.datagrid-row-detail").closest("tr").prev();if(a.length){var t=parseInt(a.attr("datagrid-row-index")),r=a.closest("div.datagrid-view").children("table");i(r[0],t)}}e(this,t)})},getParentGrid:function(e){var t=e.closest("div.datagrid-row-detail");return t.length?t.closest(".datagrid-view").children(".datagrid-f"):null},getParentRowIndex:function(e){var t=e.closest("div.datagrid-row-detail");if(t.length){var a=t.closest("tr").prev();return parseInt(a.attr("datagrid-row-index"))}return-1}});